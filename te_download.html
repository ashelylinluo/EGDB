<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TE Superfamilies and Families Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #selection-container {
            margin-bottom: 20px;
        }
        #charts-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .chart-wrapper {
            width: 48%;
        }
        #barChart {
            height: 750px !important;
        }
        #pieChart {
            height: 800px !important;
        }
        #download-button {
            margin-top: 10px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        #download-button:hover {
            background-color: #45a049;
        }
        .dataTables_wrapper {
            margin-top: 20px;
            overflow-x: auto;
        }
        /* 确保表格容器有足够的空间显示分页控件 */
        #teInformationTable_wrapper {
            margin-bottom: 50px;
        }
        /* 分页按钮样式 */
        .dataTables_paginate {
            margin-top: 10px !important;
        }
        /* 确保分页控件可见 */
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 0.5em 1em;
            margin-left: 2px;
        }
        table {
            width: 100%;
            table-layout: auto;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>TE Annotation and Visualization</h1>
    <div id="selection-container">
        <label for="species-select">Choose a species:</label>
        <select id="species-select">
            <option value="Setaria_viridis_pie.csv">Setaria viridis</option>
            <option value="Miscanthus_sinensis_pie.csv">Miscanthus sinensis</option>
            <option value="Miscanthus_lutarioriparius_pie.csv">Miscanthus lutarioriparius</option>
            <option value="Cenchrus_purpureus_pie.csv">Cenchrus purpureus</option>
            <option value="Cenchrus_fungigraminus_pie.csv">Cenchrus fungigraminus</option>
            <option value="Cenchrus_purpureus_purple_pie.csv">Cenchrus purpureus Purple</option>
        </select>
        <button onclick="loadCharts()">Show Charts</button>
    </div>
    <div id="charts-container">
        <div class="chart-wrapper">
            <canvas id="barChart"></canvas>
        </div>
        <div class="chart-wrapper">
            <canvas id="pieChart"></canvas>
        </div>
    </div>

    <h2>TE Search</h2>
    <form id="search-form">
        Select Species:
        <select id="species-search-select">
            <option value="Cenchrus_purpureus_purple.TE.csv">Cenchrus purpureus purple</option>
            <option value="Cenchrus_purpureus.TE.csv">Cenchrus purpureus</option>
            <option value="Cenchrus_fungigraminus.TE.csv">Cenchrus fungigraminus</option>
            <option value="Miscanthus_lutarioriparius.TE.csv">Miscanthus lutarioriparius</option>
            <option value="Miscanthus_sinensis.TE.csv">Miscanthus sinensis</option>
            <option value="Setaria_viridis.TE.csv">Setaria viridis</option>
        </select>
        <br><br>
        Region (e.g., 57000-57250): <input type="text" id="region" placeholder="Enter region">
        TE Family (e.g., CACTA): <input type="text" id="family" placeholder="Enter TE family">
        <button type="button" onclick="searchTE()">Search</button>
    </form>

    <button id="download-button" onclick="downloadResults()">Download Results</button>

    <div class="dataTables_wrapper">
        <table id="teInformationTable" class="display">
            <thead>
                <tr>
                    <th>chr</th>
                    <th>start</th>
                    <th>end</th>
                    <th>information</th>
                    <th>phase</th>
                    <th>strand</th>
                    <th>TE family</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <script>
        let barChartInstance = null;
        let pieChartInstance = null;
        let dataTable;

        function loadCharts() {
            const speciesSelect = document.getElementById('species-select');
            const filePath = "./" + speciesSelect.value;

            Papa.parse(filePath, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log("CSV data loaded:", results);

                    if (results.errors.length > 0) {
                        console.error("Errors parsing CSV:", results.errors);
                        alert("Errors occurred while parsing the CSV file. Check the console for details.");
                        return;
                    }

                    let data = results.data;
                    data = data.map(row => ({ label: row['TE family'], count: parseInt(row['Count'], 10) }))
                                .filter(row => !isNaN(row.count))
                                .sort((a, b) => b.count - a.count);

                    const labels = data.map(row => row.label);
                    const counts = data.map(row => row.count);
                    const colors = generateColors(labels.length);

                    if (labels.length > 0 && counts.length > 0) {
                        generateBarChart(labels, counts, colors);
                        generatePieChart(labels, counts, colors);
                    } else {
                        console.error("No valid data found in CSV file.");
                        alert("No valid data found in CSV file. Please check the file format and content.");
                    }
                }
            });
        }

        function generateBarChart(labels, counts, colors) {
            const barCtx = document.getElementById('barChart').getContext('2d');
            if (barChartInstance) {
                barChartInstance.destroy();
            }
            barChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Number of Transposable Elements by Family'
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function generatePieChart(labels, counts, colors) {
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            if (pieChartInstance) {
                pieChartInstance.destroy();
            }
            pieChartInstance = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right'
                        },
                        title: {
                            display: true,
                            text: 'Proportion of Transposable Elements by Family'
                        }
                    }
                }
            });
        }

        function generateColors(length) {
            const colors = [];
            const baseColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'
            ];
            for (let i = 0; i < length; i++) {
                colors.push(baseColors[i % baseColors.length]);
            }
            return colors;
        }

        function initializeDataTable(data) {
            if (dataTable) {
                dataTable.destroy();
            }

            const tableData = data.map(row => [
                row.chr,
                row.start,
                row.end,
                row.information,
                row.phase,
                row.strand,
                row['TE family']
            ]);

            dataTable = $('#teInformationTable').DataTable({
                data: tableData,
                pageLength: 10,
                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
                ordering: true,
                searching: true,
                paging: true,
                info: true,
                dom: 'lBfrtip',
                language: {
                    paginate: {
                        previous: "Previous",
                        next: "Next"
                    },
                    lengthMenu: "Show _MENU_ entries",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries"
                }
            });
        }

        function searchTE() {
            const species = document.getElementById('species-search-select').value;
            const region = document.getElementById('region').value;
            const family = document.getElementById('family').value;
            const filePath = "./" + species;

            Papa.parse(filePath, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    let data = results.data;

                    if (region) {
                        const [startRange, endRange] = region.split('-').map(Number);
                        data = data.filter(row => {
                            const start = parseInt(row['start'], 10);
                            const end = parseInt(row['end'], 10);
                            return start >= startRange && end <= endRange;
                        });
                    }
                    if (family) {
                        data = data.filter(row => row['TE family'] && row['TE family'].toLowerCase().includes(family.toLowerCase()));
                    }

                    initializeDataTable(data);
                }
            });
        }

        function downloadResults() {
            if (!dataTable) {
                alert('Please perform a search first.');
                return;
            }

            const data = dataTable.rows({ search: 'applied' }).data().toArray();
            const headers = ['chr', 'start', 'end', 'information', 'phase', 'strand', 'TE family'];
            const csvContent = "data:text/csv;charset=utf-8,"
                + headers.join(",") + "\n"
                + data.map(row => row.join(",")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "TE_Search_Results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 页面加载完成后初始化空表格
        $(document).ready(function() {
            initializeDataTable([]);
            loadCharts(); // 自动加载初始图表
        });
    </script>
</body>
</html>