<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gene Expression Network and Heatmap</title>
    <script src="https://cdn.plot.ly/plotly-2.9.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.21.0/dist/cytoscape.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <style>
        body { 
            margin: 0; 
            font-family: Arial, sans-serif; 
            height: 100vh;
            overflow: hidden;
        }
        .container { 
            display: flex; 
            flex-direction: column;
            width: 100%;
            height: 100vh;
        }
        .header {
            background-color: #f4f4f4;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .visualization { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            padding: 10px; 
            gap: 10px;
            overflow-y: auto;
        }
        .chart-container { 
            border: 1px solid #ddd; 
            height: calc(33vh - 20px);
            min-height: 250px;
        }
        #heatmap { width: 100%; }
        #network-container { width: 100%; }
        #gene-search-panel { width: 100%; }
        .search-container {
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            margin-bottom: 10px;
        }
        .search-input {
            width: 200px;
            padding: 5px;
            margin-right: 10px;
        }
        .search-button {
            padding: 5px 10px;
            background-color: #0074D9;
            color: white;
            border: none;
            cursor: pointer;
        }
        .search-button:hover {
            background-color: #0056b3;
        }
        #gene-expression-plot {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <label for="species-select">Select Species:</label>
            <select id="species-select">
                <option value="Arundo_donax.csv">Arundo donax</option>
                <option value="Cenchrus_fungigraminus.csv">Cenchrus fungigraminus</option>
                <option value="Cenchrus_purpureus.csv">Cenchrus purpureus</option>
                <option value="Cenchrus_purpureus_purple.csv">Cenchrus purpureus purple</option>
                <option value="Miscanthus_lutarioriparius.csv">Miscanthus lutarioriparius</option>
                <option value="Miscanthus_sacchariflorus.csv" selected>Miscanthus sacchariflorus</option>
                <option value="Miscanthus_sinensis.csv">Miscanthus sinensis</option>
                <option value="Setaria_viridis.csv">Setaria viridis</option>
            </select>
            <div class="search-container">
                <input type="text" id="gene-search" class="search-input" placeholder="Enter gene ID...">
                <button id="search-button" class="search-button">Search Gene</button>
            </div>
        </header>

        <main class="visualization">
            <div id="heatmap" class="chart-container"></div>
            <div id="network-container" class="chart-container"></div>
            <div id="gene-search-panel" class="chart-container">
                <div id="gene-expression-plot"></div>
            </div>
        </main>
    </div>

    <script>
        let currentData = null;
        const speciesSelect = document.getElementById('species-select');
        const geneSearchInput = document.getElementById('gene-search');
        const searchButton = document.getElementById('search-button');
        
        speciesSelect.addEventListener('change', loadSpeciesData);
        searchButton.addEventListener('click', searchGene);
        
        function loadSpeciesData() {
            const selectedSpecies = speciesSelect.value;
            Papa.parse(`./${selectedSpecies}`, {
                download: true,
                header: true,
                complete: function(results) {
                    currentData = results.data;
                    const topGenes = currentData.sort((a, b) => 
                        averageExpression(b) - averageExpression(a)
                    ).slice(0, 20);

                    const labels = Object.keys(topGenes[0]).slice(1);
                    const geneIds = topGenes.map(row => row.gene_id);
                    const expressionData = topGenes.map(row => 
                        Object.values(row).slice(1).map(v => log2Transform(Number(v)))
                    );

                    drawHeatmap(labels, geneIds, expressionData);
                    drawNetwork(geneIds, expressionData);
                }
            });
        }

        function searchGene() {
            const searchTerm = geneSearchInput.value.trim();
            if (!searchTerm || !currentData) return;

            const geneData = currentData.find(row => row.gene_id.includes(searchTerm));
            if (geneData) {
                const tissues = Object.keys(geneData).slice(1);
                const expressionValues = tissues.map(tissue => Number(geneData[tissue]));
                
                const trace = {
                    x: tissues,
                    y: expressionValues,
                    type: 'bar',
                    name: geneData.gene_id,
                    marker: {
                        color: '#0074D9'
                    }
                };

                const layout = {
                    title: `Expression Profile for ${geneData.gene_id}`,
                    xaxis: {
                        title: 'Tissues',
                        tickangle: -45
                    },
                    yaxis: {
                        title: 'Expression Level (TPM)'
                    },
                    margin: {
                        b: 150
                    }
                };

                const config = {
                    responsive: true
                };

                Plotly.newPlot('gene-expression-plot', [trace], layout, config);
            } else {
                alert('Gene not found!');
            }
        }

        function averageExpression(gene) {
            const values = Object.values(gene).slice(1).map(Number);
            return values.reduce((a, b) => a + b, 0) / values.length;
        }

        function log2Transform(value) {
            return Math.log2(value + 1);
        }

        function drawHeatmap(labels, geneIds, expressionData) {
            const data = [{
                z: expressionData,
                x: labels,
                y: geneIds,
                type: 'heatmap',
                colorscale: [
                    [0, 'rgb(255, 255, 204)'],
                    [1, 'rgb(0, 0, 128)']
                ],
                colorbar: {
                    len: 0.15,
                    thickness: 8,
                    tickfont: { size: 8 },
                    title: {
                        text: 'log2(TPM+1)',
                        font: { size: 8 }
                    }
                }
            }];

            const layout = {
                title: 'Top Genes Heatmap (log2 transformed)',
                xaxis: {
                    title: 'Samples',
                    tickangle: -45,
                    tickfont: {
                        size: 10
                    },
                    automargin: true
                },
                yaxis: {
                    title: 'Genes',
                    automargin: true
                },
                margin: {
                    t: 50,
                    r: 30,
                    b: 150,
                    l: 200
                }
            };

            const config = { 
                responsive: true,
                toImageButtonOptions: {
                    format: 'svg',
                    filename: 'gene_expression_heatmap',
                    height: 800,
                    width: 1200,
                    scale: 1
                }
            };
            
            Plotly.newPlot('heatmap', data, layout, config);
        }

        function drawNetwork(geneIds, expressionData) {
            const elements = geneIds.map(id => ({ data: { id } }));
            const degrees = {};

            for (let i = 0; i < geneIds.length; i++) {
                degrees[geneIds[i]] = 0;
                for (let j = i + 1; j < geneIds.length; j++) {
                    const corr = pearsonCorrelation(expressionData[i], expressionData[j]);
                    if (corr >= 0.8) {
                        elements.push({ data: { source: geneIds[i], target: geneIds[j] } });
                        degrees[geneIds[i]]++;
                        degrees[geneIds[j]]++;
                    }
                }
            }

            const cy = cytoscape({
                container: document.getElementById('network-container'),
                elements: elements,
                layout: { name: 'circle' },
                style: [
                    { selector: 'node', style: {
                        'background-color': ele => degrees[ele.id()] > 5 ? 'red' : '#0074D9',
                        'label': 'data(id)'
                    }},
                    { selector: 'edge', style: { 'line-color': '#ccc', 'width': 1.5 } }
                ]
            });
        }

        function pearsonCorrelation(x, y) {
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((acc, _, i) => acc + x[i] * y[i], 0);
            const sumX2 = x.reduce((a, b) => a + b ** 2, 0);
            const sumY2 = y.reduce((a, b) => a + b ** 2, 0);
            return (n * sumXY - sumX * sumY) / Math.sqrt((n * sumX2 - sumX ** 2) * (n * sumY2 - sumY ** 2));
        }

        // Initial load
        loadSpeciesData();
    </script>
</body>
</html>