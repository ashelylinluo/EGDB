<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gene Expression Network and Heatmap</title>
    <script src="https://cdn.plot.ly/plotly-2.9.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.21.0/dist/cytoscape.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <style>
        body { 
            margin: 0; 
            font-family: Arial, sans-serif; 
            height: 100vh;
            overflow: hidden;
        }
        .container { 
            display: flex; 
            width: 100%;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }
        .visualization { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            padding: 10px; 
            gap: 10px;
            overflow-y: auto;
        }
        .chart-container { 
            border: 1px solid #ddd; 
            height: calc(50vh - 20px);
            min-height: 300px;
        }
        #heatmap { width: 100%; }
        #network-container { width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <main class="visualization">
            <div id="heatmap" class="chart-container"></div>
            <div id="network-container" class="chart-container"></div>
        </main>
    </div>

    <script>
        const csvFilePath = "./Miscanthus_sacchariflorus.csv";

        Papa.parse(csvFilePath, {
            download: true,
            header: true,
            complete: function(results) {
                const data = results.data;

                const topGenes = data.sort((a, b) => 
                    averageExpression(b) - averageExpression(a)
                ).slice(0, 20); // 限制为20个基因

                const labels = Object.keys(topGenes[0]).slice(1);
                const geneIds = topGenes.map(row => row.gene_id);
                const expressionData = topGenes.map(row => 
                    Object.values(row).slice(1).map(v => log2Transform(Number(v)))
                );

                drawHeatmap(labels, geneIds, expressionData);
                drawNetwork(geneIds, expressionData);
            }
        });

        function averageExpression(gene) {
            const values = Object.values(gene).slice(1).map(Number);
            return values.reduce((a, b) => a + b, 0) / values.length;
        }

        function log2Transform(value) {
            return Math.log2(value + 1);
        }

        function drawHeatmap(labels, geneIds, expressionData) {
            const data = [{
                z: expressionData,
                x: labels,
                y: geneIds,
                type: 'heatmap',
                colorscale: [
                    [0, 'rgb(255, 255, 204)'],
                    [1, 'rgb(0, 0, 128)']
                ],
                colorbar: {
                    len: 0.15,
                    thickness: 8,
                    tickfont: { size: 8 },
                    title: {
                        text: 'log2(TPM+1)',
                        font: { size: 8 }
                    }
                }
            }];

            const layout = {
                title: 'Top Genes Heatmap (log2 transformed)',
                xaxis: { title: 'Samples' },
                yaxis: { title: 'Genes', automargin: true },
                margin: { t: 50, r: 30, b: 50, l: 200 }, // 增大左边距，避免标签裁剪
                height: 800 // 增大热图高度
            };

            const config = {
                responsive: true
            };

            Plotly.newPlot('heatmap', data, layout, config);
        }

        function drawNetwork(geneIds, expressionData) {
            const elements = geneIds.map(id => ({ data: { id } }));
            const degrees = {};

            for (let i = 0; i < geneIds.length; i++) {
                degrees[geneIds[i]] = 0;
                for (let j = i + 1; j < geneIds.length; j++) {
                    const corr = pearsonCorrelation(expressionData[i], expressionData[j]);
                    if (corr >= 0.8) {
                        elements.push({ data: { source: geneIds[i], target: geneIds[j] } });
                        degrees[geneIds[i]]++;
                        degrees[geneIds[j]]++;
                    }
                }
            }

            const cy = cytoscape({
                container: document.getElementById('network-container'),
                elements: elements,
                layout: { name: 'circle' },
                style: [
                    { selector: 'node', style: {
                        'background-color': ele => degrees[ele.id()] > 5 ? 'red' : '#0074D9',
                        'label': 'data(id)'
                    }},
                    { selector: 'edge', style: { 'line-color': '#ccc', 'width': 1.5 } }
                ]
            });
        }

        function pearsonCorrelation(x, y) {
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((acc, _, i) => acc + x[i] * y[i], 0);
            const sumX2 = x.reduce((a, b) => a + b ** 2, 0);
            const sumY2 = y.reduce((a, b) => a + b ** 2, 0);
            return (n * sumXY - sumX * sumY) / Math.sqrt((n * sumX2 - sumX ** 2) * (n * sumY2 - sumY ** 2));
        }
    </script>
</body>
</html>
