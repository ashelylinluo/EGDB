<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Grass Phenotype Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        .container {
            width: 95%;
            margin: 20px auto;
        }
        .search-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .search-container select, .search-container button {
            margin: 5px;
            padding: 8px;
        }
        .content {
            display: flex;
        }
        .sidebar {
            width: 250px;
            padding: 15px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .main-content {
            flex-grow: 1;
            margin-left: 20px;
        }
        .chart-container {
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 15px;
        }
        .debug-info {
            background-color: #e9e9e9;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        

        <div class="content">
            <div class="sidebar">
                <div class="search-container" style="margin-bottom: 20px;">
                    <select id="year-select">
                        <option value="">Select Year</option>
                    </select>
                    <select id="type-select">
                        <option value="">Select Type</option>
                    </select>
                </div>
                <h3>Filter Options</h3>
                <div id="trait-filters">
                    <!-- Trait checkboxes will be dynamically added here -->
                </div>
                <button onclick="updateCharts()">Update Charts</button>
            </div>

            <div class="main-content">
                <div class="chart-container">
                    <h3>Pairplot</h3>
                    <div id="pairplotContainer"></div>
                </div>
                <div class="chart-container">
                    <h3>Grouped Bar Chart</h3>
                    <canvas id="groupedBarChartCanvas"></canvas>
                </div>
            </div>
        </div>

        <div class="debug-info">
            <h3>Debug Information:</h3>
            <pre id="debug-output"></pre>
        </div>
    </div>

    <script>
        let csvData = [];
        const traits = [
            {id: 'Ht', name: 'Plant Height (Ht)'},
            {id: 'CC', name: 'Compressed Circumference (CC)'},
            {id: 'BC', name: 'Basal Circumference (BC)'},
            {id: 'CC/BC', name: 'Compressed Circumference to Basal Circumference Ratio (CC/BC)'},
            {id: 'YPP', name: 'Yield per Plant (YPP)'},
            {id: 'YPF', name: 'Yield per Footprint (YPF)'},
            {id: 'DBI', name: 'Culm Basal Internode Diameter (DBI)'},
            {id: 'DTI', name: 'Culm Topmost Internode Diameter (DTI)'},
            {id: 'CmDen', name: 'Culm Density (CmDen)'},
            {id: 'CmDW', name: 'Culm Dry Weight (CmDW)'},
            {id: 'CmNN', name: 'Culm Node Number (CmNN)'},
            {id: 'CmVol', name: 'Culm Volume (CmVol)'}
        ];
        let years = new Set();
        let types = new Set();
        let charts = {};

        // Automatically load CSV file
        document.addEventListener('DOMContentLoaded', function() {
            loadCSV();
        });

        function loadCSV() {
            const filePath = 'http://localhost:8000/202401018phenotype.csv';  // Automatically load CSV file path
            updateDebugInfo('Attempting to load CSV from: ' + filePath);
            Papa.parse(filePath, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    csvData = results.data;
                    updateDebugInfo('CSV loaded successfully. Row count: ' + csvData.length);
                    processCSVData();
                },
                error: function(error) {
                    updateDebugInfo('Error loading CSV: ' + error);
                }
            });
        }

        function processCSVData() {
            csvData.forEach(row => {
                if (row['Year']) years.add(row['Year'].trim());
                if (row['Type']) types.add(row['Type'].trim());
            });

            populateFilters();
            populateDropdowns();
        }

        function populateFilters() {
            const traitFilters = document.getElementById('trait-filters');
            traitFilters.innerHTML = traits.map(trait => 
                `<label><input type="checkbox" value="${trait.id}"> ${trait.name}</label><br>`
            ).join('');
        }

        function populateDropdowns() {
            const yearSelect = document.getElementById('year-select');
            const typeSelect = document.getElementById('type-select');

            yearSelect.innerHTML = '<option value="">Select Year</option>';
            typeSelect.innerHTML = '<option value="">Select Type</option>';

            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });

            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });
        }

        function updateCharts() {
            const selectedTraits = Array.from(document.querySelectorAll('#trait-filters input:checked')).map(input => input.value);
            if (selectedTraits.length > 0) {
                updateDebugInfo('Generating charts for selected traits...');
                updatePairplot(selectedTraits, csvData);
                updateGroupedBarChart(selectedTraits, csvData);
            } else {
                updateDebugInfo('Please select at least one trait to generate the charts.');
            }
        }

        function updateGroupedBarChart(selectedTraits, data) {
            updateDebugInfo('Updating grouped bar chart with selected traits: ' + selectedTraits.join(', '));
            const ctx = document.getElementById('groupedBarChartCanvas').getContext('2d');
            if (charts.groupedBarChart) charts.groupedBarChart.destroy();

            const labels = Array.from(new Set(data.map(row => row['Type'])));
            updateDebugInfo('Labels for grouped bar chart: ' + labels.join(', '));
            const datasets = selectedTraits.map(trait => {
                const datasetValues = labels.map(label => {
                    const filteredData = data.filter(row => row['Type'] === label);
                    const values = filteredData.map(row => parseFloat(row[trait])).filter(val => !isNaN(val));
                    const averageValue = values.length ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                    updateDebugInfo(`Trait: ${trait}, Label: ${label}, Average Value: ${averageValue}`);
                    return averageValue;
                });
                return {
                    label: trait,
                    data: datasetValues,
                    backgroundColor: `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.5)`
                };
            });

            charts.groupedBarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            enabled: true
                        }
                    },
                    title: {
                        display: true,
                        text: 'Grouped Bar Chart of Selected Traits'
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Type'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Average Value'
                            }
                        }
                    }
                }
            });
        }

        function updatePairplot(selectedTraits, data) {
            const pairplotContainer = document.getElementById('pairplotContainer');
            pairplotContainer.innerHTML = '';

            selectedTraits.forEach((traitX, i) => {
                selectedTraits.slice(i + 1).forEach(traitY => {
                    const canvas = document.createElement('canvas');
                    pairplotContainer.appendChild(canvas);

                    const dataset = data.map(row => {
                        const x = parseFloat(row[traitX]);
                        const y = parseFloat(row[traitY]);
                        if (isNaN(x) || isNaN(y)) {
                            updateDebugInfo(`Skipping row due to invalid data for traits: ${traitX}, ${traitY}`);
                        }
                        return { x, y };
                    }).filter(pair => !isNaN(pair.x) && !isNaN(pair.y));

                    new Chart(canvas.getContext('2d'), {
                        type: 'scatter',
                        data: {
                            datasets: [{
                                label: `${traits.find(t => t.id === traitX).name} vs ${traits.find(t => t.id === traitY).name}`,
                                data: dataset,
                                backgroundColor: `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.3)`,
                                pointRadius: 3
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    enabled: true
                                }
                            },
                            title: { display: true, text: `${traitX} vs ${traitY}` },
                            scales: {
                                x: {
                                    type: 'linear',
                                    position: 'bottom',
                                    title: {
                                        display: true,
                                        text: traits.find(t => t.id === traitX).name
                                    },
                                    grid: {
                                        color: 'rgba(200, 200, 200, 0.3)'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: traits.find(t => t.id === traitY).name
                                    },
                                    grid: {
                                        color: 'rgba(200, 200, 200, 0.3)'
                                    }
                                }
                            }
                        }
                    });
                });
            });
        }

        function updateDebugInfo(message) {
            const debugOutput = document.getElementById('debug-output');
            debugOutput.textContent += message + '\n';
        }
    </script>
</body>
</html>
